
//: Declare String Begin

/*: "init(coder:) has not been implemented" :*/
fileprivate let noti_colorId:[UInt8] = [0x2f,0x28,0x2f,0x32,0x6e,0x25,0x29,0x22,0x23,0x34,0x7c,0x6f,0x66,0x2e,0x27,0x35,0x66,0x28,0x29,0x32,0x66,0x24,0x23,0x23,0x28,0x66,0x2f,0x2b,0x36,0x2a,0x23,0x2b,0x23,0x28,0x32,0x23,0x22]

private func currentManager(app num: UInt8) -> UInt8 {
    return num ^ 70
}

/*: "#292929" :*/
fileprivate let appLabStr:[Character] = ["#","2","9","2","9","2","9"]

/*: "9999999" :*/
fileprivate let appPostId:String = "plainplainplainplainplain"
fileprivate let show_searchMessage:[Character] = ["9","9"]

/*: "icon_coin" :*/
fileprivate let k_whiteUrl:[Character] = ["i","c","o","n","_","c","o","i","n"]

/*: "icon_gift_more_arrow" :*/
fileprivate let main_equalStr:[Character] = ["i","c","o","n","_","g","i","f","t","_"]
fileprivate let user_colorText:[Character] = ["m","o","r","e","_","a","r","r","o","w"]

/*: "Hot" :*/
fileprivate let app_panTitle:String = "true section itemHot"

/*: "VIP" :*/
fileprivate let show_selectKey:[Character] = ["V","I","P"]

/*: "Bags" :*/
fileprivate let noti_rawIdent:String = "Bagssize let sub model self"

/*: "icon_gift_num_arrow" :*/
fileprivate let m_valueUrl:String = "value in at stackicon_g"
fileprivate let app_viewUrl:String = "object any make add titlenum_arro"
fileprivate let k_userLogIfData:String = "me"

/*: "Send" :*/
fileprivate let dreamCellData:[Character] = ["S","e","n","d"]

/*: "nav_back_black_nor" :*/
fileprivate let show_tableAppearUrl:String = "nav_view view self"
fileprivate let notiErrorContent:[Character] = ["a","c","k","_","n","o","r"]

/*: "The number of gifts cannot be less than 1" :*/
fileprivate let dreamPresentationScaleKey:[UInt8] = [0x31,0x20,0x6e,0x61,0x68,0x74,0x20,0x73,0x73,0x65,0x6c,0x20,0x65,0x62,0x20,0x74,0x6f,0x6e,0x6e,0x61,0x63,0x20,0x73,0x74,0x66,0x69,0x67,0x20,0x66,0x6f,0x20,0x72,0x65,0x62,0x6d,0x75,0x6e,0x20,0x65,0x68,0x54]

/*: "Please select a gift" :*/
fileprivate let main_countMessage:[Character] = ["P","l","e","a","s","e"," ","s","e","l","e","c","t"," ","a"," ","g","i","f","t"]

/*: "Please select an object" :*/
fileprivate let mainLimitMakeMessage:String = "to to moment charity colorPleas"
fileprivate let main_managerEqualFormat:String = "lect avar name model add gift"
fileprivate let showResultObserveMessage:[Character] = ["t"]

/*: "Select the desired gift to unlock" :*/
fileprivate let kRowMomentId:[UInt8] = [0x39,0xf,0x6,0xf,0x9,0x1e,0x4a,0x1e,0x2,0xf,0x4a,0xe,0xf,0x19,0x3,0x18,0xf,0xe,0x4a,0xd,0x3,0xc,0x1e,0x4a,0x1e,0x5,0x4a,0x1f,0x4,0x6,0x5,0x9,0x1]

private func joinDataSize(kit num: UInt8) -> UInt8 {
    return num ^ 106
}

/*: "OK" :*/
fileprivate let m_textContent:[Character] = ["O","K"]

/*: "Select object >" :*/
fileprivate let notiLabIdent:String = "let tip manager in nextSele"
fileprivate let dreamOkId:String = "of textect >"

/*: "It looks like there's nothing" :*/
fileprivate let noti_blockAddName:[Character] = ["I","t"," ","l","o","o","k","s"," ","l","i","k","e"," ","t","h","e","r","e","\'","s"," ","n","o"]
fileprivate let noti_atDataIdent:[Character] = ["t","h","i","n","g"]

/*: "FF75A4" :*/
fileprivate let kManagerUrl:String = "angleangle75A4"

/*: "E570FF" :*/
fileprivate let mFileData:String = "status570FF"

/*: "Ask for" :*/
fileprivate let notiLayerUrl:String = "Ask foruser if"

/*: " Select %@ > " :*/
fileprivate let mainShareIdent:String = " Seleview var"
fileprivate let showCurrentName:String = "error>error"

/*: "All Numbers" :*/
fileprivate let kItemName:[Character] = ["A","l","l"," ","N","u","m","b","e","r","s"]

/*: "View detailed description >" :*/
fileprivate let notiBirthMsg:String = "list sizeView"
fileprivate let main_animaTitle:String = "aoned"
fileprivate let main_labTableMakeValue:String = "view input view color case de"
fileprivate let appStyleValue:String = "SCRIPT"

/*: "\n" :*/
fileprivate let m_lockData:String = "\n"

/*: "%.2f" :*/
fileprivate let userBottomFormat:[Character] = ["%",".","2","f"]

/*: "9999" :*/
fileprivate let showManagerUrl:String = "interactioninteractioninteractioninteraction"

/*: "Custom" :*/
fileprivate let k_errorMessage:String = "Customstring for sub appeal"

/*: "mf_coin" :*/
fileprivate let user_wrapEnableTitle:String = "title view succeed var contentmf_co"
fileprivate let userManagerMessage:String = "model"

/*: "showBagsRed" :*/
fileprivate let userTopCenterKey:String = "head true moment titleshowBa"
fileprivate let dreamLoadId:[Character] = ["g","s","R","e","d"]

//: Declare String End

// __DEBUG__
// __CLOSE_PRINT__
//
//  ChatDatabaseThen.swift
//  AbroadTalking
//
//  Created by Charlotte on 2022/9/6.
//

//: import RxSwift
import RxSwift
//: import UIKit
import UIKit

/// 礼物面板UI样式
//: enum GiftViewStyle: String {
enum ConstraintValueConvertible: String {
    //: case normal = "0"          // 默认送礼
    case normal = "0" // 默认送礼
    //: case intimatePhoto = "1"   // 私密照片送礼
    case intimatePhoto = "1" // 私密照片送礼
    //: case intimateVideo = "2"   // 视频送礼（目前和私密照片样式一致）
    case intimateVideo = "2" // 视频送礼（目前和私密照片样式一致）
    //: case groupChat = "3"       // 群聊礼物
    case groupChat = "3" // 群聊礼物
    //: case live = "4"            // 直播礼物
    case live = "4" // 直播礼物
    //: case call = "5"            // 音视频通话
    case call = "5" // 音视频通话
    //: case party = "6"           // 语聊房
    case party = "6" // 语聊房
}

/// 礼物面板数据类型
//: enum GiftDataType: Int {
enum PrixFixeSubscriptType: Int {
    //: case Hot = 0
    case Hot = 0 // 默认礼物
    //: case Vip = 1
    case Vip = 1 // vip礼物
    //: case Bags = 2
    case Bags = 2 // 背包礼物
}

// 发送礼物Block
//: typealias SendFunctionBlock = (_ giftModel: TalkingRoomGiftModel, _ num: String) -> Void
typealias SendFunctionBlock = (_ giftModel: NnwTransformable, _ num: String) -> Void
// 索要礼物Block
//: typealias AskforFunctionBlock = (_ giftModel: TalkingRoomGiftModel, _ num: String) -> Void
typealias AskforFunctionBlock = (_ giftModel: NnwTransformable, _ num: String) -> Void
// 私密照片发送礼物Block
//: typealias OKButtonBlock = (_ giftModel: TalkingRoomGiftModel) -> Void
typealias OKButtonBlock = (_ giftModel: NnwTransformable) -> Void
// 群聊发送礼物Block
//: typealias ChatRoomSendActionBlock = (_ giftModel: TalkingRoomGiftModel, _ num: String, _ model: TalkingChatRoomMemberModel) -> Void
typealias ChatRoomSendActionBlock = (_ giftModel: NnwTransformable, _ num: String, _ model: WriteMemberModel) -> Void
// 隐藏礼物面板Block
//: typealias GiftViewHideBlock = () -> Void
typealias GiftViewHideBlock = () -> Void

// 礼物各模块高度
//: private let topView_H = 44.0
private let kProfileValue = 44.0
//: let GiftScrollContentView_H = 252.0
let k_objectContent = 252.0
//: private let pageControl_H = 7.0
private let kUserValue = 7.0
//: private let bottomView_H = 44.0
private let k_screenTabData = 44.0

//: class TalkingChatGiftView: UIView {
class ChatDatabaseThen: UIView {
    //: var chatRoomID = ""
    var chatRoomID = ""
    //: var showOtherInputView = false
    var showOtherInputView = false
    //: var contentHeight = topView_H + GiftScrollContentView_H + pageControl_H + bottomView_H + kDeviceSafeBottomHeight
    var contentHeight = kProfileValue + k_objectContent + kUserValue + k_screenTabData + k_videoName
    //: var keyborHeight = 0
    var keyborHeight = 0
    //: var sendActionBlock: SendFunctionBlock!
    var sendActionBlock: SendFunctionBlock!
    //: var askforActionBlock: AskforFunctionBlock!
    var askforActionBlock: AskforFunctionBlock!
    //: var chatRoomSendActionBlock: ChatRoomSendActionBlock!
    var chatRoomSendActionBlock: ChatRoomSendActionBlock!
    //: var giftHideBlock: GiftViewHideBlock!
    var giftHideBlock: GiftViewHideBlock!
    //: var okActionBlock: OKButtonBlock?
    var okActionBlock: OKButtonBlock?

    //: fileprivate lazy var disposeBag = DisposeBag()
    fileprivate lazy var disposeBag = DisposeBag()
    //: private var style: GiftViewStyle = .normal
    private var style: ConstraintValueConvertible = .normal
    //: var giftSelectedModel = TalkingGiftSelectedModel()
    var giftSelectedModel = DatabaseTransformable()
    //: var chatRoomgiftSelectedMemberModel: TalkingChatRoomMemberModel?
    var chatRoomgiftSelectedMemberModel: WriteMemberModel?
    //: var popView: TalkingPopView?
    var popView: SucceedReactiveCompatible?
    //: var meneView = DropDownMemberMenuView()
    var meneView = OfDataSource()
    //: fileprivate var recentmenuArray = NSMutableArray.init()
    fileprivate var recentmenuArray = NSMutableArray()
    //: let maxRecentmenu = 2
    let maxRecentmenu = 2
    //: private var titlesArr = [GiftDataType]()
    private var titlesArr = [PrixFixeSubscriptType]()
    // 当前选中数据类型
    //: private var currType = GiftDataType.Hot
    private var currType = PrixFixeSubscriptType.Hot
    //: private var isShowRight = false
    private var isShowRight = false
    /// 初始化礼物背包
    /// - Parameters:
    ///   - frame: 布局
    ///   - style: 礼物面板UI样式
    ///   - titlesArr: 礼物面板数据类型
    //: init(frame: CGRect = .zero, style: GiftViewStyle = .normal, titlesArr: [GiftDataType] = [.Hot, .Vip, .Bags]) {
    init(frame: CGRect = .zero, style: ConstraintValueConvertible = .normal, titlesArr: [PrixFixeSubscriptType] = [.Hot, .Vip, .Bags]) {
        //: super.init(frame: frame)
        super.init(frame: frame)
        //: self.style = style
        self.style = style
        //: self.titlesArr = titlesArr
        self.titlesArr = titlesArr
        //: self.currType = titlesArr.first ?? .Hot
        self.currType = titlesArr.first ?? .Hot
        //: self.backgroundColor = UIColor.clear
        self.backgroundColor = UIColor.clear
        //: self.isUserInteractionEnabled = true
        self.isUserInteractionEnabled = true
        //: if self.style == .party {
        if self.style == .party {
            //: contentHeight += TalkingVoiceRoomIconGiftView_H
            contentHeight += k_localBarNextValue
        }
        //: setupSubviews()
        aggregation()
        //: bindInteraction()
        tabularMatterSumeraction()
        //: if LanguageManager.shared.direction == .rightToLeft {
        if ManagerThen.shared.direction == .rightToLeft {
            //: let transform = CATransform3DMakeRotation(CGFloat(Double.pi), 0, 1, 0)
            let transform = CATransform3DMakeRotation(CGFloat(Double.pi), 0, 1, 0)
            //: hotGiftCollectionView.layer.transform = transform
            hotGiftCollectionView.layer.transform = transform
            //: self.isShowRight = true
            self.isShowRight = true
        }
    }

    //: required init?(coder: NSCoder) {
    required init?(coder _: NSCoder) {
        //: fatalError("init(coder:) has not been implemented")
        fatalError(String(bytes: noti_colorId.map{currentManager(app: $0)}, encoding: .utf8)!)
    }

    //: deinit {
    deinit {
        //: NotificationCenter.default.removeObserver(self)
        NotificationCenter.default.removeObserver(self)
    }

    // MARK: - Lazy Load

    //: private lazy var contentView: UIView = {
    private lazy var contentView: UIView = {
        //: let frame = CGRect(x: 0, y: ScreenHeight, width: ScreenWidth, height: contentHeight)
        let frame = CGRect(x: 0, y: kHalfText, width: kBlockRateValue, height: contentHeight)
        //: let content = UIView(frame: frame)
        let content = UIView(frame: frame)
        //: content.backgroundColor = .init(hex: "#292929")
        content.backgroundColor = .init(hex: (String(appLabStr)))
        //: content.Corner(width: ScreenWidth, height: contentHeight, corners: [.topLeft, .topRight], cornerRadii: .init(width: 15, height: 15))
        content.attributeAt(width: kBlockRateValue, height: contentHeight, corners: [.topLeft, .topRight], cornerRadii: .init(width: 15, height: 15))
        //: self.addSubview(content)
        self.addSubview(content)
        //: return content
        return content
        //: }()
    }()

    //: lazy var partyIconView: TalkingVoiceRoomIconGiftView = {
    lazy var partyIconView: UserContentGiftView = {
        //: let frame = CGRect(x: 0, y: 0, width: ScreenWidth, height: TalkingVoiceRoomIconGiftView_H)
        let frame = CGRect(x: 0, y: 0, width: kBlockRateValue, height: k_localBarNextValue)
        //: let view = TalkingVoiceRoomIconGiftView(frame: frame)
        let view = UserContentGiftView(frame: frame)
        //: view.isHidden = true
        view.isHidden = true
        //: contentView.addSubview(view)
        contentView.addSubview(view)
        //: return view
        return view
        //: }()
    }()

    //: private lazy var topView: UIView = {
    private lazy var topView: UIView = {
        //: let frame = CGRect(x: 0, y: 0, width: ScreenWidth, height: topView_H)
        let frame = CGRect(x: 0, y: 0, width: kBlockRateValue, height: kProfileValue)
        //: let view = UIView(frame: frame)
        let view = UIView(frame: frame)
        //: view.backgroundColor = .init(hex: "#292929")
        view.backgroundColor = .init(hex: (String(appLabStr)))
        //: contentView.addSubview(view)
        contentView.addSubview(view)
        //: return view
        return view
        //: }()
    }()

    //: private lazy var moneyBtn: TalkingButton = {
    private lazy var moneyBtn: RowView = {
        //: let btn = TalkingButton()
        let btn = RowView()
        //: btn.setTitleColor(UIColor.white, for: .normal)
        btn.setTitleColor(UIColor.white, for: .normal)
        //: btn.titleLabel?.font = UIFont.pingfangFont(type: .Medium, fontSize: 14)
        btn.titleLabel?.font = UIFont.fontFile(type: .Medium, fontSize: 14)
        //: btn.setTitle("9999999", for: .normal)
        btn.setTitle((appPostId.replacingOccurrences(of: "plain", with: "9") + String(show_searchMessage)), for: .normal)
        //: btn.setImage(UIImage.BundleImageNamed(name: "icon_coin"), for: .normal)
        btn.setImage(UIImage.namedImageNameBundle(name: (String(k_whiteUrl))), for: .normal)
        //: btn.spaceBetweenTitleAndImage = 4
        btn.spaceBetweenTitleAndImage = 4
        //: return btn
        return btn
        //: }()
    }()

    //: private lazy var rechargeBtn: UIButton = {
    private lazy var rechargeBtn: UIButton = {
        //: let btn = UIButton.init()
        let btn = UIButton()
        //: btn.backgroundColor = .clear
        btn.backgroundColor = .clear
        //: btn.addTarget(self, action: #selector(rechargeBtnClick), for: .touchUpInside)
        btn.addTarget(self, action: #selector(white), for: .touchUpInside)

        //: return btn
        return btn
        //: }()
    }()

    //: private lazy var indicatorImage: UIImageView = {
    private lazy var indicatorImage: UIImageView = {
        //: let img = UIImageView.init()
        let img = UIImageView()
        //: img.image = UIImage.BundleImageNamed(name: "icon_gift_more_arrow")
        img.image = UIImage.namedImageNameBundle(name: (String(main_equalStr) + String(user_colorText)))
        //: return img
        return img
        //: }()
    }()

    //: private lazy var pageControl: UIPageControl = {
    private lazy var pageControl: UIPageControl = {
        //: let page = UIPageControl.init()
        let page = UIPageControl()
        //: page.hidesForSinglePage = true
        page.hidesForSinglePage = true
        //: page.defersCurrentPageDisplay = true
        page.defersCurrentPageDisplay = true
        //: page.currentPageIndicatorTintColor = UIColor.RGBA(180, 180, 180, 1)
        page.currentPageIndicatorTintColor = UIColor.my(180, 180, 180, 1)
        //: page.pageIndicatorTintColor = UIColor.RGBA(60, 60, 60, 1)
        page.pageIndicatorTintColor = UIColor.my(60, 60, 60, 1)
        //: page.isEnabled = false
        page.isEnabled = false
        //: return page
        return page
        //: }()
    }()

    //: private lazy var scrollContentView: UIScrollView = {
    private lazy var scrollContentView: UIScrollView = {
        //: let scroll = UIScrollView.init()
        let scroll = UIScrollView()
        //: scroll.backgroundColor = .clear
        scroll.backgroundColor = .clear
        //: return scroll
        return scroll
        //: }()
    }()

    //: private lazy var hotGiftCollectionView: UICollectionView = {
    private lazy var hotGiftCollectionView: UICollectionView = {
        //: let layout = TalkingChatGiftLayout.init()
        let layout = ResultGiftLayout()
        //: layout.scrollDirection = .horizontal
        layout.scrollDirection = .horizontal
        //: let hot = UICollectionView.init(frame: .zero, collectionViewLayout: layout)
        let hot = UICollectionView(frame: .zero, collectionViewLayout: layout)
        //: hot.delegate = self
        hot.delegate = self
        //: hot.dataSource = self
        hot.dataSource = self
        //: hot.bounces = false
        hot.bounces = false
        //: hot.isPagingEnabled = true
        hot.isPagingEnabled = true
        //: hot.showsHorizontalScrollIndicator = false
        hot.showsHorizontalScrollIndicator = false
        //: hot.backgroundColor = .clear
        hot.backgroundColor = .clear
        //: hot.isHidden = false
        hot.isHidden = false
        //: hot.register(TalkingPackageGiftCell.self, forCellWithReuseIdentifier: TalkingPackageGiftCell.className())
        hot.register(ResultWorkThen.self, forCellWithReuseIdentifier: ResultWorkThen.className())
        //: return hot
        return hot
        //: }()
    }()

    //: private lazy var hotGiftLayout: TalkingChatGiftLayout = {
    private lazy var hotGiftLayout: ResultGiftLayout = //: return hotGiftCollectionView.collectionViewLayout as! ResultGiftLayout
        hotGiftCollectionView.collectionViewLayout as! ResultGiftLayout
    //: }()

    //: private lazy var bottomView: UIView = {
    private lazy var bottomView: UIView = {
        //: let view = UIView.init()
        let view = UIView()
        //: return view
        return view
        //: }()
    }()

    //: private lazy var titleScrollView: ScrollSegmentView = {
    private lazy var titleScrollView: PositionDeviceSegmentView = {
        //: var titles = [String]()
        var titles = [String]()
        //: titlesArr.forEach { type in
        titlesArr.forEach { type in
            //: switch type {
            switch type {
            //: case .Hot:
            case .Hot:
                //: titles.append("Hot".localized)
                titles.append((String(app_panTitle.suffix(3))).localized)
            //: case .Vip:
            case .Vip:
                //: titles.append("VIP".localized)
                titles.append((String(show_selectKey)).localized)
            //: case .Bags:
            case .Bags:
                //: titles.append("Bags".localized)
                titles.append((String(noti_rawIdent.prefix(4))).localized)
            }
        }
        //: var style = SegmentStyle()
        var style = PasskeySegmentStyle()
        //: style.scrollTitle = true
        style.scrollTitle = true
        //: style.showLine = true
        style.showLine = true
        //: style.scrollLineColor = .white
        style.scrollLineColor = .white

        //: let scrollview = ScrollSegmentView(frame: CGRect(x: 0, y: 0, width: titlesArr.count*50, height: Int(topView_H)), segmentStyle: style, titles: titles)
        let scrollview = PositionDeviceSegmentView(frame: CGRect(x: 0, y: 0, width: titlesArr.count * 50, height: Int(kProfileValue)), segmentStyle: style, titles: titles)
        //: if LanguageManager.shared.direction == .rightToLeft {
        if ManagerThen.shared.direction == .rightToLeft {
            //: scrollview.frame.origin.x = MacroReactiveCompatible.getScreenWidth()-scrollview.frame.width
            scrollview.frame.origin.x = MacroReactiveCompatible.totalimateLastCurrent() - scrollview.frame.width
        }
        // 点击标题，联动礼物面板
        //: scrollview.titleBtnOnClick = { [weak self] _, index in
        scrollview.titleBtnOnClick = { [weak self] _, index in
            //: guard let self = self else { return }
            guard let self = self else { return }
            //: guard index != self.currType.rawValue else { return }
            guard index != self.currType.rawValue else { return }
            //: let indexPath = IndexPath(item: 0, section: index)
            let indexPath = IndexPath(item: 0, section: index)
            //: self.hotGiftCollectionView.selectItem(at: indexPath, animated: false, scrollPosition: .centeredVertically)
            self.hotGiftCollectionView.selectItem(at: indexPath, animated: false, scrollPosition: .centeredVertically)
        }
        // 处理红点
        //: scrollview.redBagsLab.isHidden = !TalkingChatGiftManager.share.showBagsRed
        scrollview.redBagsLab.isHidden = !TrivialityThen.share.showBagsRed
        //: return scrollview
        return scrollview
        //: }()
    }()

    //: private lazy var sendAreaView: UIView = {
    private lazy var sendAreaView: UIView = {
        //: let view = UIView.init()
        let view = UIView()
        //: view.layer.borderColor  = UIColor.appThemeColor().cgColor
        view.layer.borderColor = UIColor.subject().cgColor
        //: view.layer.borderWidth  = 1
        view.layer.borderWidth = 1
        //: view.layer.cornerRadius = 15
        view.layer.cornerRadius = 15
        //: view.clipsToBounds      = true
        view.clipsToBounds = true
        //: return view
        return view
        //: }()
    }()

    //: private lazy var giftNumButton: TalkingButton = {
    private lazy var giftNumButton: RowView = {
        //: let btn = TalkingButton.init()
        let btn = RowView()
        //: btn.titleLabel?.font = UIFont.pingfangFont(type: .Regular, fontSize: 14)
        btn.titleLabel?.font = UIFont.fontFile(type: .Regular, fontSize: 14)
        //: btn.backgroundColor = .clear
        btn.backgroundColor = .clear
        //: btn.imageView?.contentMode = .scaleAspectFit
        btn.imageView?.contentMode = .scaleAspectFit
        //: btn.setTitleColor(UIColor.white, for: .normal)
        btn.setTitleColor(UIColor.white, for: .normal)
        //: btn.setImage(UIImage.BundleImageNamed(name: "icon_gift_num_arrow"), for: .normal)
        btn.setImage(UIImage.namedImageNameBundle(name: (String(m_valueUrl.suffix(6)) + "ift_" + String(app_viewUrl.suffix(8)) + k_userLogIfData.replacingOccurrences(of: "me", with: "w"))), for: .normal)
        //: btn.imageAlignment = .right
        btn.imageAlignment = .right
        //: btn.spaceBetweenTitleAndImage = 4
        btn.spaceBetweenTitleAndImage = 4
        //: btn.addTarget(self, action: #selector(giftNumBtnClick), for: .touchUpInside)
        btn.addTarget(self, action: #selector(largessAndClick), for: .touchUpInside)

        //: return btn
        return btn
        //: }()
    }()

    //: private lazy var sendButton: UIButton = {
    private lazy var sendButton: UIButton = {
        //: let btn = UIButton.init()
        let btn = UIButton()
        //: btn.titleLabel?.font = UIFont.pingfangFont(type: .Semibold, fontSize: 15)
        btn.titleLabel?.font = UIFont.fontFile(type: .Semibold, fontSize: 15)
        //: btn.backgroundColor = UIColor.appThemeColor()
        btn.backgroundColor = UIColor.subject()
        //: btn.setTitleColor(UIColor.white, for: .normal)
        btn.setTitleColor(UIColor.white, for: .normal)
        //: btn.setTitle("Send".localized, for: .normal)
        btn.setTitle((String(dreamCellData)).localized, for: .normal)
        //: btn.addTarget(self, action: #selector(onTouchSendGiftBtn), for: .touchUpInside)
        btn.addTarget(self, action: #selector(giftCollideWithAlongSend), for: .touchUpInside)

        //: return btn
        return btn
        //: }()
    }()

    //: private lazy var giftInputNumInputView: UIView = {
    private lazy var giftInputNumInputView: UIView = {
        //: let view = UIView.init(frame: CGRect(x: 0, y: ScreenHeight-CGFloat(keyborHeight)-44, width: ScreenWidth, height: 44))
        let view = UIView(frame: CGRect(x: 0, y: kHalfText - CGFloat(keyborHeight) - 44, width: kBlockRateValue, height: 44))
        //: view.backgroundColor = .black
        view.backgroundColor = .black
        //: let backButton = UIButton.init()
        let backButton = UIButton()
        //: let img = UIImage.BundleImageNamed(name: "nav_back_black_nor").withRenderingMode(.alwaysTemplate)
        let img = UIImage.namedImageNameBundle(name: (String(show_tableAppearUrl.prefix(4)) + "back_bl" + String(notiErrorContent))).withRenderingMode(.alwaysTemplate)
        //: backButton.setImage(img, for: .normal)
        backButton.setImage(img, for: .normal)
        //: backButton.tintColor = .white
        backButton.tintColor = .white
        //: view.addSubview(backButton)
        view.addSubview(backButton)
        //: backButton.snp.makeConstraints { make in
        backButton.snp.makeConstraints { make in
            //: make.leading.top.equalTo(view)
            make.leading.top.equalTo(view)
            //: make.width.height.equalTo(44)
            make.width.height.equalTo(44)
        }
        //: backButton.rx.tap.subscribe { (event) in
        backButton.rx.tap.subscribe { _ in
            //: self.popView?.dismissView()
            self.popView?.statusMode()
            //: self.popView = nil
            self.popView = nil
            //: }.disposed(by: disposeBag)
        }.disposed(by: disposeBag)

        //: let sendButton = UIButton.init()
        let sendButton = UIButton()
        //: sendButton.setBackgroundColor(color: .appThemeColor(), forState: .normal)
        sendButton.note(color: .subject(), forState: .normal)
        //: sendButton.setTitleColor(UIColor.white, for: .normal)
        sendButton.setTitleColor(UIColor.white, for: .normal)
        //: sendButton.setTitle("Send".localized, for: .normal)
        sendButton.setTitle((String(dreamCellData)).localized, for: .normal)
        //: view.addSubview(sendButton)
        view.addSubview(sendButton)
        //: sendButton.snp.makeConstraints { make in
        sendButton.snp.makeConstraints { make in
            //: make.trailing.top.equalTo(view)
            make.trailing.top.equalTo(view)
            //: make.width.equalTo(106)
            make.width.equalTo(106)
            //: make.height.equalTo(44)
            make.height.equalTo(44)
        }
        //: sendButton.rx.tap.subscribe { [weak self](event) in
        sendButton.rx.tap.subscribe { [weak self] _ in
            //: guard let self = self else { return }
            guard let self = self else { return }
            //: let str: String = self.giftInputNumTF.text ?? "0"
            let str: String = self.giftInputNumTF.text ?? "0"
            //: guard Int(str) ?? 0 >= 1 else {
            guard Int(str) ?? 0 >= 1 else {
                //: self.func__showStatusBarErrorMsg(showMsg: "The number of gifts cannot be less than 1".localized)
                self.actionKey(showMsg: String(bytes: dreamPresentationScaleKey.reversed(), encoding: .utf8)!.localized)
                //: return
                return
            }
            //: guard self.giftSelectedModel.lastHotIndexPath.row >= 0 else {
            guard self.giftSelectedModel.lastHotIndexPath.row >= 0 else {
                //: self.func__showStatusBarErrorMsg(showMsg: "Please select a gift".localized)
                self.actionKey(showMsg: (String(main_countMessage)).localized)
                //: return
                return
            }

            //: self.giftSelectedModel.hotGiftNum = Int(str) ?? 1
            self.giftSelectedModel.hotGiftNum = Int(str) ?? 1
            //: self.giftNumButton.setTitle(str, for: .normal)
            self.giftNumButton.setTitle(str, for: .normal)
            //: self.afterChangeNum()
            self.ice()

            //: if self.chatRoomID.count > 0 {
            if self.chatRoomID.count > 0 {
                //: guard self.chatRoomgiftSelectedMemberModel != nil else {
                guard self.chatRoomgiftSelectedMemberModel != nil else {
                    //: self.func__showStatusBarErrorMsg(showMsg: "Please select an object".localized)
                    self.actionKey(showMsg: (String(mainLimitMakeMessage.suffix(5)) + "e se" + String(main_managerEqualFormat.prefix(6)) + "n objec" + String(showResultObserveMessage)).localized)
                    //: return
                    return
                }
                //: if self.chatRoomSendActionBlock != nil {
                if self.chatRoomSendActionBlock != nil {
                    //: let index = self.giftSelectedModel.lastHotIndexPath.row
                    let index = self.giftSelectedModel.lastHotIndexPath.row
                    //: guard let dataType = GiftDataType(rawValue: self.giftSelectedModel.lastHotIndexPath.section) else { return }
                    guard let dataType = PrixFixeSubscriptType(rawValue: self.giftSelectedModel.lastHotIndexPath.section) else { return }
                    //: let dataArr = self.getGiftData(dataType: dataType)
                    let dataArr = self.capability(dataType: dataType)
                    //: if index < dataArr.count {
                    if index < dataArr.count {
                        //: let giftModel: TalkingRoomGiftModel = dataArr[index] as! TalkingRoomGiftModel
                        let giftModel: NnwTransformable = dataArr[index] as! NnwTransformable
                        //: self.chatRoomSendActionBlock(giftModel, String(self.giftSelectedModel.hotGiftNum), self.chatRoomgiftSelectedMemberModel!)
                        self.chatRoomSendActionBlock(giftModel, String(self.giftSelectedModel.hotGiftNum), self.chatRoomgiftSelectedMemberModel!)
                    }
                }
                //: } else {
            } else {
                //: let index = self.giftSelectedModel.lastHotIndexPath.row
                let index = self.giftSelectedModel.lastHotIndexPath.row
                //: guard let dataType = GiftDataType(rawValue: self.giftSelectedModel.lastHotIndexPath.section) else { return }
                guard let dataType = PrixFixeSubscriptType(rawValue: self.giftSelectedModel.lastHotIndexPath.section) else { return }
                //: let dataArr = self.getGiftData(dataType: dataType)
                let dataArr = self.capability(dataType: dataType)
                //: if index < dataArr.count {
                if index < dataArr.count {
                    //: let giftModel: TalkingRoomGiftModel = dataArr[index] as! TalkingRoomGiftModel
                    let giftModel: NnwTransformable = dataArr[index] as! NnwTransformable
                    //: if self.sendActionBlock != nil {
                    if self.sendActionBlock != nil {
                        //: self.sendActionBlock(giftModel, String(self.giftSelectedModel.hotGiftNum))
                        self.sendActionBlock(giftModel, String(self.giftSelectedModel.hotGiftNum))
                    }
                }
            }

            //: self.popView?.dismissView()
            self.popView?.statusMode()
            //: self.popView = nil
            self.popView = nil

            //: }.disposed(by: disposeBag)
        }.disposed(by: disposeBag)

        //: view.addSubview(giftInputNameLabel)
        view.addSubview(giftInputNameLabel)
        //: giftInputNameLabel .snp.makeConstraints { make in
        giftInputNameLabel.snp.makeConstraints { make in
            //: make.leading.equalTo(44)
            make.leading.equalTo(44)
            //: make.top.equalTo(view)
            make.top.equalTo(view)
            //: make.height.equalTo(44)
            make.height.equalTo(44)
        }
        //: view.addSubview(giftInputNumTF)
        view.addSubview(giftInputNumTF)
        //: giftInputNumTF .snp.makeConstraints { make in
        giftInputNumTF.snp.makeConstraints { make in
            //: make.centerX.equalTo(view.snp.centerX)
            make.centerX.equalTo(view.snp.centerX)
            //: make.top.equalTo(view)
            make.top.equalTo(view)
            //: make.height.equalTo(44)
            make.height.equalTo(44)
            //: make.width.equalTo(100)
            make.width.equalTo(100)
        }

        //: return view
        return view
        //: }()
    }()

    //: private lazy var giftInputNameLabel: UILabel = {
    private lazy var giftInputNameLabel: UILabel = {
        //: let lb = UILabel.init()
        let lb = UILabel()
        //: lb.textColor = UIColor.appThemeColor()
        lb.textColor = UIColor.subject()
        //: return lb
        return lb
        //: }()
    }()

    //: private lazy var giftInputNumTF: UITextField = {
    private lazy var giftInputNumTF: UITextField = {
        //: let tf = UITextField.init()
        let tf = UITextField()
        //: tf.keyboardType = .asciiCapableNumberPad
        tf.keyboardType = .asciiCapableNumberPad
        //: tf.textColor=UIColor.white
        tf.textColor = UIColor.white
        //: tf.textAlignment = .center
        tf.textAlignment = .center
        //: tf.addTarget(self, action: #selector(keyboardInputShouldDelete(_:)), for: .editingChanged)
        tf.addTarget(self, action: #selector(tillObserver(_:)), for: .editingChanged)

        //: NotificationCenter.default.addObserver(self, selector: #selector(keyboardWillBeHidden(notification:)), name: UIResponder.keyboardWillHideNotification, object: nil)
        NotificationCenter.default.addObserver(self, selector: #selector(velleity(notification:)), name: UIResponder.keyboardWillHideNotification, object: nil)

        //: NotificationCenter.default.addObserver(self, selector: #selector(keyboardWasShown(notification:)), name: UIResponder.keyboardWillShowNotification, object: nil)
        NotificationCenter.default.addObserver(self, selector: #selector(indexVoice(notification:)), name: UIResponder.keyboardWillShowNotification, object: nil)

        //: return tf
        return tf
        //: }()
    }()

    //: private lazy var desLab: UILabel = {
    private lazy var desLab: UILabel = {
        //: let lab = UILabel()
        let lab = UILabel()
        //: lab.text = "Select the desired gift to unlock".localized
        lab.text = String(bytes: kRowMomentId.map{joinDataSize(kit: $0)}, encoding: .utf8)!.localized
        //: lab.font = UIFont.pingfangRugularFont(fontSize: 14)
        lab.font = UIFont.font(fontSize: 14)
        //: lab.textColor = .white
        lab.textColor = .white
        //: lab.textAlignment = .right
        lab.textAlignment = .right
        //: return lab
        return lab
        //: }()
    }()

    //: private lazy var okBtn: UIButton = {
    private lazy var okBtn: UIButton = {
        //: let btn = UIButton()
        let btn = UIButton()
        //: btn.backgroundColor = UIColor.appThemeColor()
        btn.backgroundColor = UIColor.subject()
        //: btn.titleLabel?.font = UIFont.pingfangMediumFont(fontSize: 15)
        btn.titleLabel?.font = UIFont.dismissProgress(fontSize: 15)
        //: btn.setTitle("OK".localized, for: .normal)
        btn.setTitle("OK".localized, for: .normal)
        //: btn.setTitleColor(.white, for: .normal)
        btn.setTitleColor(.white, for: .normal)
        //: btn.layer.cornerRadius = 15
        btn.layer.cornerRadius = 15
        //: btn.layer.masksToBounds = true
        btn.layer.masksToBounds = true
        //: btn.addTarget(self, action: #selector(okButtonClick), for: .touchUpInside)
        btn.addTarget(self, action: #selector(equalFasteningClick), for: .touchUpInside)
        //: return btn
        return btn
        //: }()
    }()

    //: private lazy var seleteObjectBtn: UIButton = {
    private lazy var seleteObjectBtn: UIButton = {
        //: let btn = UIButton()
        let btn = UIButton()
        //: btn.backgroundColor = UIColor.clear
        btn.backgroundColor = UIColor.clear
        //: btn.titleLabel?.font = UIFont.pingfangMediumFont(fontSize: 14)
        btn.titleLabel?.font = UIFont.dismissProgress(fontSize: 14)
        //: btn.setTitle("Select object >".localized, for: .normal)
        btn.setTitle((String(notiLabIdent.suffix(4)) + "ct obj" + String(dreamOkId.suffix(5))).localized, for: .normal)
        //: btn.setTitleColor(.white, for: .normal)
        btn.setTitleColor(.white, for: .normal)
        //: btn.layer.cornerRadius = 15
        btn.layer.cornerRadius = 15
        //: btn.layer.borderColor = UIColor.appThemeColor().cgColor
        btn.layer.borderColor = UIColor.subject().cgColor
        //: btn.layer.borderWidth = 1
        btn.layer.borderWidth = 1
        //: btn.layer.masksToBounds = true
        btn.layer.masksToBounds = true
        //: btn.titleLabel?.lineBreakMode = .byTruncatingMiddle
        btn.titleLabel?.lineBreakMode = .byTruncatingMiddle
        //: btn.addTarget(self, action: #selector(seleteObjectBtnClick), for: .touchUpInside)
        btn.addTarget(self, action: #selector(notRecent), for: .touchUpInside)
        //: return btn
        return btn
        //: }()
    }()

    //: private lazy var blindBoxExplainBtn: UIButton = {
    private lazy var blindBoxExplainBtn: UIButton = {
        //: let btn = UIButton()
        let btn = UIButton()
        //: btn.backgroundColor = UIColor.black
        btn.backgroundColor = UIColor.black
        //: btn.titleLabel?.font = UIFont.pingfangMediumFont(fontSize: 14)
        btn.titleLabel?.font = UIFont.dismissProgress(fontSize: 14)
        //: btn.setTitleColor(.white, for: .normal)
        btn.setTitleColor(.white, for: .normal)
        //: btn.contentHorizontalAlignment = .right
        btn.contentHorizontalAlignment = .right
        //: btn.layer.cornerRadius = 22
        btn.layer.cornerRadius = 22
        //: btn.titleLabel?.numberOfLines = 0
        btn.titleLabel?.numberOfLines = 0
        //: btn.layer.borderColor = UIColor.appThemeColor().cgColor
        btn.layer.borderColor = UIColor.subject().cgColor
        //: btn.layer.borderWidth = 1
        btn.layer.borderWidth = 1
        //: btn.layer.masksToBounds = true
        btn.layer.masksToBounds = true
        //: btn.isHidden = true
        btn.isHidden = true
        //: btn.titleLabel?.lineBreakMode = .byTruncatingMiddle
        btn.titleLabel?.lineBreakMode = .byTruncatingMiddle
        //: btn.addTarget(self, action: #selector(blindBoxExplainBtnClick), for: .touchUpInside)
        btn.addTarget(self, action: #selector(onBlindfold), for: .touchUpInside)
        //: return btn
        return btn
        //: }()
    }()

    //: private lazy var giftEmptyView: UILabel = {
    private lazy var giftEmptyView: UILabel = {
        //: let lab = UILabel()
        let lab = UILabel()
        //: lab.textColor = .white
        lab.textColor = .white
        //: lab.font = UIFont.pingfangFont(type: .Regular, fontSize: 16)
        lab.font = UIFont.fontFile(type: .Regular, fontSize: 16)
        //: lab.text = "It looks like there's nothing".localized
        lab.text = (String(noti_blockAddName) + String(noti_atDataIdent)).localized
        //: lab.textAlignment = .center
        lab.textAlignment = .center
        //: return lab
        return lab
        //: }()
    }()

    //: private lazy var askforBtn: UIButton = {
    private lazy var askforBtn: UIButton = {
        //: let btn = UIButton()
        let btn = UIButton()
        //: btn.setBackgroundImage(UIImage.imageGradientColor(colors: [UIColor.init(hex: "FF75A4")!.cgColor, UIColor.init(hex: "E570FF")!.cgColor], size: CGSize(width: 68, height: 30)), for: .normal)
        btn.setBackgroundImage(UIImage.versionSize(colors: [UIColor(hex: (kManagerUrl.replacingOccurrences(of: "angle", with: "F")))!.cgColor, UIColor(hex: (mFileData.replacingOccurrences(of: "status", with: "E")))!.cgColor], size: CGSize(width: 68, height: 30)), for: .normal)
        //: btn.titleLabel?.font = UIFont.pingfangFont(type: .Semibold, fontSize: 15)
        btn.titleLabel?.font = UIFont.fontFile(type: .Semibold, fontSize: 15)
        //: btn.setTitleColor(.white, for: .normal)
        btn.setTitleColor(.white, for: .normal)
        //: btn.layer.cornerRadius = 15
        btn.layer.cornerRadius = 15
        //: btn.layer.masksToBounds = true
        btn.layer.masksToBounds = true
        //: btn.setTitle("Ask for".localized, for: .normal)
        btn.setTitle((String(notiLayerUrl.prefix(7))).localized, for: .normal)
        //: btn.addTarget(self, action: #selector(askforBtnClick), for: .touchUpInside)
        btn.addTarget(self, action: #selector(move), for: .touchUpInside)
        //: return btn
        return btn
        //: }()
    }()
}

// MARK: - Event

//: extension TalkingChatGiftView {
extension ChatDatabaseThen {
    /// 隐藏视图
    //: @objc func dismissView() {
    @objc func whereabouts() {
        //: if giftHideBlock != nil {
        if giftHideBlock != nil {
            //: giftHideBlock()
            giftHideBlock()
        }
        //: UIView.animate(withDuration: 0.3) {
        UIView.animate(withDuration: 0.3) {
            //: self.alpha = 0
            self.alpha = 0
            //: self.contentView.frame = CGRect(x: 0, y: ScreenHeight, width: ScreenWidth, height: self.contentHeight)
            self.contentView.frame = CGRect(x: 0, y: kHalfText, width: kBlockRateValue, height: self.contentHeight)
            //: } completion: { _ in
        } completion: { _ in
            //: self.removeFromSuperview()
            self.removeFromSuperview()
        }
    }

    /// 展示视图
    //: func showView() {
    func cellView() {
        //: UIView.animate(withDuration: 0.3, animations: {
        UIView.animate(withDuration: 0.3, animations: {
            //: self.alpha = 1.0
            self.alpha = 1.0
            //: self.contentView.frame = CGRect(x: 0, y: ScreenHeight-self.contentHeight, width: ScreenWidth, height: self.contentHeight)
            self.contentView.frame = CGRect(x: 0, y: kHalfText - self.contentHeight, width: kBlockRateValue, height: self.contentHeight)
            //: }, completion: nil)
        }, completion: nil)
    }

    // ok按钮点击事件
    //: @objc private func okButtonClick() {
    @objc private func equalFasteningClick() {
        //: let index = self.giftSelectedModel.lastHotIndexPath.row
        let index = self.giftSelectedModel.lastHotIndexPath.row
        //: guard let dataType = GiftDataType(rawValue: giftSelectedModel.lastHotIndexPath.section) else { return }
        guard let dataType = PrixFixeSubscriptType(rawValue: giftSelectedModel.lastHotIndexPath.section) else { return }
        //: let dataArr = self.getGiftData(dataType: dataType)
        let dataArr = self.capability(dataType: dataType)
        //: guard index < dataArr.count else { return }
        guard index < dataArr.count else { return }

        //: let giftModel: TalkingRoomGiftModel = dataArr[index] as! TalkingRoomGiftModel
        let giftModel: NnwTransformable = dataArr[index] as! NnwTransformable
        //: if self.okActionBlock != nil {
        if self.okActionBlock != nil {
            //: self.okActionBlock!(giftModel)
            self.okActionBlock!(giftModel)
        }
        //: dismissView()
        whereabouts()
    }

    //: @objc func seleteObjectBtnClick() {
    @objc func notRecent() {
        //: meneView = DropDownMemberMenuView.init(frame: .zero, anchorView: seleteObjectBtn, roomID: self.chatRoomID)
        meneView = OfDataSource(frame: .zero, anchorView: seleteObjectBtn, roomID: self.chatRoomID)
        //: meneView.menuDelegate = self
        meneView.menuDelegate = self
        //: if self.recentmenuArray.count > 0 {
        if self.recentmenuArray.count > 0 {
            //: meneView.recentmenuArray = self.recentmenuArray
            meneView.recentmenuArray = self.recentmenuArray
        }
    }

    //: @objc func blindBoxExplainBtnClick() {
    @objc func onBlindfold() {
        //: dismissView()
        whereabouts()
        //: SucceedInfoReactiveCompatible.share.func__pushToWebVC(webViewType: .luckyBlindBox)
        SucceedInfoReactiveCompatible.share.dominant(webViewType: .luckyBlindBox)
    }

    /// 索要礼物
    //: @objc func askforBtnClick() {
    @objc func move() {
        //: guard self.giftSelectedModel.lastHotIndexPath.row >= 0 else {
        guard self.giftSelectedModel.lastHotIndexPath.row >= 0 else {
            //: self.func__showStatusBarErrorMsg(showMsg: "Please select a gift".localized)
            self.actionKey(showMsg: (String(main_countMessage)).localized)
            //: return
            return
        }
        //: self.giftSelectedModel.hotGiftNum = 1
        self.giftSelectedModel.hotGiftNum = 1
        //: self.afterChangeNum()
        self.ice()
        //: giftNumButton.setTitle(String(giftSelectedModel.hotGiftNum), for: .normal)
        giftNumButton.setTitle(String(giftSelectedModel.hotGiftNum), for: .normal)
        //: let index = self.giftSelectedModel.lastHotIndexPath.row
        let index = self.giftSelectedModel.lastHotIndexPath.row
        //: guard let dataType = GiftDataType(rawValue: self.giftSelectedModel.lastHotIndexPath.section) else { return }
        guard let dataType = PrixFixeSubscriptType(rawValue: self.giftSelectedModel.lastHotIndexPath.section) else { return }
        //: let dataArr = self.getGiftData(dataType: dataType)
        let dataArr = self.capability(dataType: dataType)
        //: if index < dataArr.count {
        if index < dataArr.count {
            //: let giftModel: TalkingRoomGiftModel = dataArr[index] as! TalkingRoomGiftModel
            let giftModel: NnwTransformable = dataArr[index] as! NnwTransformable
            //: if self.askforActionBlock != nil {
            if self.askforActionBlock != nil {
                //: self.askforActionBlock(giftModel, String(self.giftSelectedModel.hotGiftNum))
                self.askforActionBlock(giftModel, String(self.giftSelectedModel.hotGiftNum))
            }
        }
    }
}

// MARK: - 礼物背包

//: extension TalkingChatGiftView {
extension ChatDatabaseThen {
    /// 移除礼物背包
    /// - Parameters:
    ///   - pkgItemsetId: 背包Id
    ///   - num: 减少数量
    //: func bags_removeGiftPackage(pkgItemsetId: String, num: Int) {
    func errorOf(pkgItemsetId: String, num: Int) {
        //: guard currType == .Bags else { return }
        guard currType == .Bags else { return }
        //: DispatchQueue.main.async {
        DispatchQueue.main.async {
            //: var bagsDataArr = self.getGiftData(dataType: self.currType) as! [TalkingRoomGiftModel]
            var bagsDataArr = self.capability(dataType: self.currType) as! [NnwTransformable]
            // 找到当前背包礼物索引，更新数量
            //: if let index = bagsDataArr.firstIndex(where: {$0.pkgItemsetId == pkgItemsetId}) {
            if let index = bagsDataArr.firstIndex(where: { $0.pkgItemsetId == pkgItemsetId }) {
                //: bagsDataArr[index].num -= num
                bagsDataArr[index].num -= num
                // 移除空数据，取消选中状态
                //: if bagsDataArr[index].num <= 0 {
                if bagsDataArr[index].num <= 0 {
                    //: bagsDataArr.remove(at: index)
                    bagsDataArr.remove(at: index)
                    //: self.resetGiftSelectedModel()
                    self.barModel()
                }
            }

            //: TalkingChatGiftManager.share.saveGiftDataSource(dataType: self.currType, dataArr: bagsDataArr)
            TrivialityThen.share.typeAdd(dataType: self.currType, dataArr: bagsDataArr)
            //: self.hotGiftLayout.bagsDataArr = bagsDataArr
            self.hotGiftLayout.bagsDataArr = bagsDataArr
            //: self.hotGiftCollectionView.reloadData()
            self.hotGiftCollectionView.reloadData()
            // 刷新UI
            //: self.updatePageControlAndRefreshUI(force: true)
            self.pieDog(force: true)
        }
    }
}

// MARK: - ModelDetailViewDelegate

//: extension TalkingChatGiftView: DropDownMemberMenuViewDelegate {
extension ChatDatabaseThen: ModelDetailViewDelegate {
    //: func didClickSelectedRow(model: TalkingChatRoomMemberModel) {
    func terrace(model: WriteMemberModel) {
        //: self.chatRoomgiftSelectedMemberModel = model
        self.chatRoomgiftSelectedMemberModel = model
        //: seleteObjectBtn.setTitle(" Select %@ > ".localizedArguments(model.nickname), for: .normal)
        seleteObjectBtn.setTitle((String(mainShareIdent.prefix(5)) + "ct %@" + showCurrentName.replacingOccurrences(of: "error", with: " ")).localizedDataArguments(model.nickname), for: .normal)
    }

    /// 存储聊天室最近送礼人
    //: func saveRecentMembers() {
    func rescueWithinMembers() {
        //: guard self.chatRoomgiftSelectedMemberModel != nil  else { return }
        guard self.chatRoomgiftSelectedMemberModel != nil else { return }
        //: let model = self.chatRoomgiftSelectedMemberModel!
        let model = self.chatRoomgiftSelectedMemberModel!
        //: if model.nickname == "All Numbers".localized {
        if model.nickname == (String(kItemName)).localized {
            //: return
            return
        }
        //: var ishave = false
        var ishave = false
        //: for tmodel in recentmenuArray {
        for tmodel in recentmenuArray {
            //: let temp = tmodel as! TalkingChatRoomMemberModel
            let temp = tmodel as! WriteMemberModel
            //: if temp.uid == model.uid {
            if temp.uid == model.uid {
                //: ishave = true
                ishave = true
            }
        }
        //: if !ishave {
        if !ishave {
            //: if recentmenuArray.count == maxRecentmenu {
            if recentmenuArray.count == maxRecentmenu {
                //: recentmenuArray.removeFirstObject()
                recentmenuArray.removeFirstObject()
                //: recentmenuArray.add(model)
                recentmenuArray.add(model)
                //: } else {
            } else {
                //: recentmenuArray.add(model)
                recentmenuArray.add(model)
            }
        }
    }

    /// 设置盲盒礼物提醒UI
    //: func setsetBlindBoxExplainData(title: String) {
    func finishTable(title: String) {
        //: let str = "View detailed description >".localized
        let str = (String(notiBirthMsg.suffix(4)) + " det" + main_animaTitle.replacingOccurrences(of: "on", with: "il") + String(main_labTableMakeValue.suffix(3)) + appStyleValue.lowercased() + "ion >").localized
        //: let str2 = title + "\n" + str
        let str2 = title + "\n" + str
        //: blindBoxExplainBtn.isHidden = false
        blindBoxExplainBtn.isHidden = false
        //: let attributedString = NSMutableAttributedString(string: str2)
        let attributedString = NSMutableAttributedString(string: str2)
        //: let range: Range = str2.range(of: str)!
        let range: Range = str2.range(of: str)!
        //: let location = str2.distance(from: str2.startIndex, to: range.lowerBound )
        let location = str2.distance(from: str2.startIndex, to: range.lowerBound)
        //: attributedString.addAttribute(NSAttributedString.Key.underlineStyle, value: NSUnderlineStyle.single.rawValue, range: NSRange(location: location, length: str.count-2))
        attributedString.addAttribute(NSAttributedString.Key.underlineStyle, value: NSUnderlineStyle.single.rawValue, range: NSRange(location: location, length: str.count - 2))
        //: blindBoxExplainBtn.setAttributedTitle(attributedString, for: .normal)
        blindBoxExplainBtn.setAttributedTitle(attributedString, for: .normal)
        //: blindBoxExplainBtn.titleEdgeInsets = UIEdgeInsets(top: 0, left: 0, bottom: 0, right: 18)
        blindBoxExplainBtn.titleEdgeInsets = UIEdgeInsets(top: 0, left: 0, bottom: 0, right: 18)
    }
}

// MARK: - UICollectionViewDelegate, UICollectionViewDataSource

//: extension TalkingChatGiftView: UICollectionViewDelegate, UICollectionViewDataSource {
extension ChatDatabaseThen: UICollectionViewDelegate, UICollectionViewDataSource {
    //: func getGiftData(dataType: GiftDataType) -> [Any] {
    func capability(dataType: PrixFixeSubscriptType) -> [Any] {
        //: return TalkingChatGiftManager.share.getHotGiftDataSource(dataType: dataType)
        return TrivialityThen.share.voiceView(dataType: dataType)
    }

    //: func giftSendItems() -> Array<Any> {
    func magnitudeimateLive() -> [Any] {
        //: return TalkingChatGiftManager.share.getSendingItems()
        return TrivialityThen.share.showMessage()
    }

    /// 刷新礼物面板
    /// - Parameters:
    ///   - needReload: 是否需要刷新
    ///   - mf_coin: 金币
    //: func updateGiftInfo(needReload: Bool, mf_coin: String) {
    func doingInfo(needReload: Bool, mf_coin: String) {
        //: let coin = Double(mf_coin) ?? 0.0
        let coin = Double(mf_coin) ?? 0.0
        //: moneyBtn.setTitle(String.init(format: "%.2f", coin), for: .normal)
        moneyBtn.setTitle(String(format: "%.2f", coin), for: .normal)

        //: guard needReload == true else { return }
        guard needReload == true else { return }

        //: let index = giftSelectedModel.lastHotIndexPath.row
        let index = giftSelectedModel.lastHotIndexPath.row
        //: let dataArr = getGiftData(dataType: currType)
        let dataArr = capability(dataType: currType)

        //: if dataArr.count > 0, index >= 0, index < dataArr.count {
        if dataArr.count > 0, index >= 0, index < dataArr.count {
            //: let hotModel: TalkingRoomGiftModel = dataArr[index] as! TalkingRoomGiftModel
            let hotModel: NnwTransformable = dataArr[index] as! NnwTransformable
            //: giftSelectedModel.lastPackageIndexPath = giftSelectedModel.lastPackageIndexPath
            giftSelectedModel.lastPackageIndexPath = giftSelectedModel.lastPackageIndexPath
            //: giftSelectedModel.packageGiftName = giftSelectedModel.packageGiftName
            giftSelectedModel.packageGiftName = giftSelectedModel.packageGiftName
            //: giftSelectedModel.packageGiftNum = giftSelectedModel.packageGiftNum
            giftSelectedModel.packageGiftNum = giftSelectedModel.packageGiftNum
            //: giftSelectedModel.hotGiftName = hotModel.name
            giftSelectedModel.hotGiftName = hotModel.name
            //: giftSelectedModel.lastShowType = hotModel.showType
            giftSelectedModel.lastShowType = hotModel.showType
            //: giftSelectedModel.lastDescription = hotModel.description
            giftSelectedModel.lastDescription = hotModel.description
            //: giftSelectedModel.isNoChangeGiftNumber = (hotModel.showType == ChatGiftType.myStery.rawValue)
            giftSelectedModel.isNoChangeGiftNumber = (hotModel.showType == LibraryTotalervalLiteral.myStery.rawValue)
        }

        //: giftNumButton.setTitle(String(giftSelectedModel.hotGiftNum), for: .normal)
        giftNumButton.setTitle(String(giftSelectedModel.hotGiftNum), for: .normal)

        // 刷新layout
        //: hotGiftLayout.sectionArr = titlesArr
        hotGiftLayout.sectionArr = titlesArr
        //: hotGiftLayout.hotDataArr = getGiftData(dataType: .Hot)
        hotGiftLayout.hotDataArr = capability(dataType: .Hot)
        //: hotGiftLayout.vipDataArr = getGiftData(dataType: .Vip)
        hotGiftLayout.vipDataArr = capability(dataType: .Vip)
        //: hotGiftLayout.bagsDataArr = getGiftData(dataType: .Bags)
        hotGiftLayout.bagsDataArr = capability(dataType: .Bags)
        //: hotGiftCollectionView.reloadData()
        hotGiftCollectionView.reloadData()

        // 刷新UI
        //: updatePageControlAndRefreshUI(force: true)
        pieDog(force: true)
    }

    /// 输入监听
    //: @objc fileprivate func keyboardInputShouldDelete(_ textField: UITextField) {
    @objc fileprivate func tillObserver(_ textField: UITextField) {
        //: let str: String = textField.text ?? ""
        let str: String = textField.text ?? ""
        //: if str.count == 2 && str.hasPrefix("0") {
        if str.count == 2 && str.hasPrefix("0") {
            //: self.giftInputNumTF.text = String(str.suffix(1))
            self.giftInputNumTF.text = String(str.suffix(1))
            //: } else if str.count > 4 {
        } else if str.count > 4 {
            //: self.giftInputNumTF.text = "9999"
            self.giftInputNumTF.text = (showManagerUrl.replacingOccurrences(of: "interaction", with: "9"))
            //: } else {
        } else {
            //: self.giftInputNumTF.text = str
            self.giftInputNumTF.text = str
        }
    }

    //: @objc func keyboardWasShown(notification: NSNotification) {
    @objc func indexVoice(notification: NSNotification) {
        //: let info = notification.userInfo!
        let info = notification.userInfo!
        //: var kbRect = (info[UIResponder.keyboardFrameEndUserInfoKey]! as! NSValue).cgRectValue
        var kbRect = (info[UIResponder.keyboardFrameEndUserInfoKey]! as! NSValue).cgRectValue
        //: kbRect = self.convert(kbRect, from: nil)
        kbRect = self.convert(kbRect, from: nil)

        //: let height = kbRect.size.height
        let height = kbRect.size.height

        //: keyborHeight = Int(height)
        keyborHeight = Int(height)
        //: giftInputNumInputView.frame = CGRect(x: 0, y: ScreenHeight-CGFloat(keyborHeight)-44, width: ScreenWidth, height: 44)
        giftInputNumInputView.frame = CGRect(x: 0, y: kHalfText - CGFloat(keyborHeight) - 44, width: kBlockRateValue, height: 44)
    }

    //: @objc func keyboardWillBeHidden(notification: NSNotification) {
    @objc func velleity(notification _: NSNotification) {
        //: var str: String = self.giftInputNumTF.text ?? ""
        var str: String = self.giftInputNumTF.text ?? ""
        //: if Int(str) ?? 0 < 1 {
        if Int(str) ?? 0 < 1 { // 最少为1
            //: str = "1"
            str = "1"
        }

        //: giftSelectedModel.hotGiftNum = Int(str) ?? 0
        giftSelectedModel.hotGiftNum = Int(str) ?? 0
        //: giftNumButton.setTitle(str, for: .normal)
        giftNumButton.setTitle(str, for: .normal)
        //: afterChangeNum()
        ice()
    }

    //: @objc func onTouchSendGiftBtn() {
    @objc func giftCollideWithAlongSend() {
        //: if self.chatRoomID.count > 0 {
        if self.chatRoomID.count > 0 {
            //: guard self.chatRoomgiftSelectedMemberModel != nil else {
            guard self.chatRoomgiftSelectedMemberModel != nil else {
                //: self.func__showStatusBarErrorMsg(showMsg: "Please select an object".localized)
                self.actionKey(showMsg: (String(mainLimitMakeMessage.suffix(5)) + "e se" + String(main_managerEqualFormat.prefix(6)) + "n objec" + String(showResultObserveMessage)).localized)
                //: return
                return
            }
            //: if self.chatRoomSendActionBlock != nil {
            if self.chatRoomSendActionBlock != nil {
                //: guard self.giftSelectedModel.lastHotIndexPath.row >= 0 else {
                guard self.giftSelectedModel.lastHotIndexPath.row >= 0 else {
                    //: self.func__showStatusBarErrorMsg(showMsg: "Please select a gift".localized)
                    self.actionKey(showMsg: (String(main_countMessage)).localized)
                    //: return
                    return
                }

                //: let index = self.giftSelectedModel.lastHotIndexPath.row
                let index = self.giftSelectedModel.lastHotIndexPath.row
                //: guard let dataType = GiftDataType(rawValue: giftSelectedModel.lastHotIndexPath.section) else { return }
                guard let dataType = PrixFixeSubscriptType(rawValue: giftSelectedModel.lastHotIndexPath.section) else { return }
                //: let dataArr = self.getGiftData(dataType: dataType)
                let dataArr = self.capability(dataType: dataType)
                //: if index < dataArr.count {
                if index < dataArr.count {
                    //: let giftModel: TalkingRoomGiftModel = dataArr[index] as! TalkingRoomGiftModel
                    let giftModel: NnwTransformable = dataArr[index] as! NnwTransformable
                    //: self.chatRoomSendActionBlock(giftModel, String(self.giftSelectedModel.hotGiftNum), self.chatRoomgiftSelectedMemberModel!)
                    self.chatRoomSendActionBlock(giftModel, String(self.giftSelectedModel.hotGiftNum), self.chatRoomgiftSelectedMemberModel!)
                }
            }
            //: } else {
        } else {
            //: guard self.giftSelectedModel.lastHotIndexPath.row >= 0 else {
            guard self.giftSelectedModel.lastHotIndexPath.row >= 0 else {
                //: self.func__showStatusBarErrorMsg(showMsg: "Please select a gift".localized)
                self.actionKey(showMsg: (String(main_countMessage)).localized)
                //: return
                return
            }

            //: let index = giftSelectedModel.lastHotIndexPath.row
            let index = giftSelectedModel.lastHotIndexPath.row
            //: guard let dataType = GiftDataType(rawValue: giftSelectedModel.lastHotIndexPath.section) else { return }
            guard let dataType = PrixFixeSubscriptType(rawValue: giftSelectedModel.lastHotIndexPath.section) else { return }
            //: let dataArr = self.getGiftData(dataType: dataType)
            let dataArr = self.capability(dataType: dataType)
            //: if index < dataArr.count {
            if index < dataArr.count {
                //: let giftModel: TalkingRoomGiftModel = dataArr[index] as! TalkingRoomGiftModel
                let giftModel: NnwTransformable = dataArr[index] as! NnwTransformable
                //: if sendActionBlock != nil {
                if sendActionBlock != nil {
                    //: sendActionBlock(giftModel, String(giftSelectedModel.hotGiftNum))
                    sendActionBlock(giftModel, String(giftSelectedModel.hotGiftNum))
                }
            }
        }
    }

    //: @objc func giftNumBtnClick() {
    @objc func largessAndClick() {
        //: if giftSelectedModel.isNoChangeGiftNumber == true {
        if giftSelectedModel.isNoChangeGiftNumber == true {
            //: return
            return
        }
        //: tapGiftNumberField()
        concentration()
    }

    //: @objc func rechargeBtnClick() {
    @objc func white() {
        //: let payWinType = ModeStageReactiveCompatible.share.appUserConfigMode.payWinType
        let payWinType = ModeStageReactiveCompatible.share.appUserConfigMode.payWinType
        //: if payWinType == 1 {
        if payWinType == 1 { // 半屏充值页
            //: SucceedInfoReactiveCompatible.share.func__pushToHalfWebVC(webViewType: .RechargeHalfPage)
            SucceedInfoReactiveCompatible.share.itemDoingObject(webViewType: .RechargeHalfPage)
            //: } else if payWinType == 2 {
        } else if payWinType == 2 { // 会员订阅弹窗
            //: SucceedInfoReactiveCompatible.share.func__pushToSubscribeAlert()
            SucceedInfoReactiveCompatible.share.funcClickParams()
        }
        //: dismissView()
        whereabouts()
    }

    //: func tapGiftNumberField() {
    func concentration() {
        //: let sendingItems = giftSendItems()
        let sendingItems = magnitudeimateLive()
        //: var titleArray = Array<String>()
        var titleArray = [String]()
        //: for i in 1..<sendingItems.count {
        for i in 1 ..< sendingItems.count {
            //: let text = String(numberOfGiftForIndex(index: i))
            let text = String(quantitativeRelationHarvestMoonObservationMe(index: i))
//            let giftNumArrModel: ValueHandyJSON = sendingItems[i] as! ValueHandyJSON
//            text += "  " + (giftNumArrModel.tag ?? "")
            //: titleArray.append(text)
            titleArray.append(text)
        }
        //: titleArray.append("Custom".localized)
        titleArray.append((String(k_errorMessage.prefix(6))).localized)

        //: Config.MenuCellConfig.menuCellHeight = 40
        Config.InfoConfig.menuCellHeight = 40

        //: let dropMenu = DropDownMenuView.pullDropDrownMenu(anchorView: giftNumButton, titleArray: titleArray, imageArray: [])
        let dropMenu = DeviceNorReactiveCompatible.menuWith(anchorView: giftNumButton, titleArray: titleArray, imageArray: [])
        //: dropMenu.menuDelegate = self
        dropMenu.menuDelegate = self
        //: dropMenu.menuStyle = .MenuLightStyle
        dropMenu.menuStyle = .MenuLightStyle
    }

    //: func afterChangeNum() {
    func ice() {
        //: let cell = self.hotGiftCollectionView.cellForItem(at: giftSelectedModel.lastHotIndexPath) as? TalkingPackageGiftCell
        let cell = self.hotGiftCollectionView.cellForItem(at: giftSelectedModel.lastHotIndexPath) as? ResultWorkThen
        //: cell?.updateSelectedNumber(number: giftSelectedModel.hotGiftNum)
        cell?.old(number: giftSelectedModel.hotGiftNum)
    }

    /// UICollectionViewDelegete
    //: func numberOfSections(in collectionView: UICollectionView) -> Int {
    func numberOfSections(in _: UICollectionView) -> Int {
        //: return titlesArr.count
        return titlesArr.count
    }

    //: func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
    func collectionView(_: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        //: guard let dataType = GiftDataType(rawValue: section) else { return 0 }
        guard let dataType = PrixFixeSubscriptType(rawValue: section) else { return 0 }
        //: let count = getGiftData(dataType: dataType).count
        let count = capability(dataType: dataType).count
        // 保证至少有一条数据，否则切换会crash
        //: return (count > 0) ? count:1
        return (count > 0) ? count : 1
    }

    //: func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
    func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
        //: let identifier = TalkingPackageGiftCell.className()
        let identifier = ResultWorkThen.className()
        //: let cell = collectionView.dequeueReusableCell(withReuseIdentifier: identifier, for: indexPath) as! TalkingPackageGiftCell
        let cell = collectionView.dequeueReusableCell(withReuseIdentifier: identifier, for: indexPath) as! ResultWorkThen
        // 获取数据
        //: guard let dataType = GiftDataType(rawValue: indexPath.section) else { return cell }
        guard let dataType = PrixFixeSubscriptType(rawValue: indexPath.section) else { return cell }
        //: let dataArr = getGiftData(dataType: dataType)
        let dataArr = capability(dataType: dataType)
        // 刷新cell
        //: if indexPath.row < dataArr.count {
        if indexPath.row < dataArr.count {
            //: cell.isHidden = false
            cell.isHidden = false
            //: let giftModel: TalkingRoomGiftModel = dataArr[indexPath.row] as! TalkingRoomGiftModel
            let giftModel: NnwTransformable = dataArr[indexPath.row] as! NnwTransformable
            //: cell.refreshCellView(currenmodel: giftModel, giftType: dataType)
            cell.circle(currenmodel: giftModel, giftType: dataType)
            //: cell.setChecked(checked: giftSelectedModel.lastHotIndexPath == indexPath)
            cell.equalSelected(checked: giftSelectedModel.lastHotIndexPath == indexPath)
            //: if giftSelectedModel.lastHotIndexPath == indexPath {
            if giftSelectedModel.lastHotIndexPath == indexPath {
                //: giftSelectedModel.lastHotCell = cell
                giftSelectedModel.lastHotCell = cell
                //: cell.updateSelectedNumber(number: giftSelectedModel.hotGiftNum)
                cell.old(number: giftSelectedModel.hotGiftNum)
            }
            //: } else {
        } else {
            //: cell.isHidden = true
            cell.isHidden = true
        }

        //: return cell
        return cell
    }

    //: func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {
    func collectionView(_: UICollectionView, didSelectItemAt indexPath: IndexPath) {
        //: guard let dataType = GiftDataType(rawValue: indexPath.section) else { return }
        guard let dataType = PrixFixeSubscriptType(rawValue: indexPath.section) else { return }
        //: let dataArr = getGiftData(dataType: dataType)
        let dataArr = capability(dataType: dataType)
        //: guard indexPath.row < dataArr.count else { return }
        guard indexPath.row < dataArr.count else { return }

        //: let giftModel: TalkingRoomGiftModel = dataArr[indexPath.row] as! TalkingRoomGiftModel
        let giftModel: NnwTransformable = dataArr[indexPath.row] as! NnwTransformable
        //: giftSelectedModel.lastShowType = giftModel.showType
        giftSelectedModel.lastShowType = giftModel.showType
        //: giftSelectedModel.isNoChangeGiftNumber = (giftModel.showType == ChatGiftType.myStery.rawValue)
        giftSelectedModel.isNoChangeGiftNumber = (giftModel.showType == LibraryTotalervalLiteral.myStery.rawValue)
        //: blindBoxExplainBtn.isHidden = !(giftModel.showType == ChatGiftType.myStery.rawValue)
        blindBoxExplainBtn.isHidden = !(giftModel.showType == LibraryTotalervalLiteral.myStery.rawValue)

        //: if giftSelectedModel.lastHotIndexPath == indexPath {
        if giftSelectedModel.lastHotIndexPath == indexPath {
            //: if self.style == .intimatePhoto || self.style == .intimateVideo {
            if self.style == .intimatePhoto || self.style == .intimateVideo {
                //: return
                return
            }
            //: giftSelectedModel.hotGiftName = giftModel.name
            giftSelectedModel.hotGiftName = giftModel.name
            //: if giftModel.showType == ChatGiftType.myStery.rawValue && style == .normal {
            if giftModel.showType == LibraryTotalervalLiteral.myStery.rawValue && style == .normal {
                //: didClickSelectedCellRow(index: 0, title: "")
                turn(index: 0, title: "")
                //: return
                return
            }
            //: var sendIndex = indexOfSendItemForNum(num: giftSelectedModel.hotGiftNum)
            var sendIndex = isometricWith(num: giftSelectedModel.hotGiftNum)
            //: sendIndex = safeObjectAtIndexWithSendItems(addIndex: sendIndex+1)
            sendIndex = via(addIndex: sendIndex + 1)
            //: didClickSelectedCellRow(index: sendIndex, title: "")
            turn(index: sendIndex, title: "")
            //: } else {
        } else {
            //: giftSelectedModel.hotGiftName = giftModel.name
            giftSelectedModel.hotGiftName = giftModel.name
            //: if giftSelectedModel.lastHotCell != nil {
            if giftSelectedModel.lastHotCell != nil {
                //: let cell: TalkingPackageGiftCell = giftSelectedModel.lastHotCell as! TalkingPackageGiftCell
                let cell: ResultWorkThen = giftSelectedModel.lastHotCell as! ResultWorkThen
                //: cell.setChecked(checked: false)
                cell.equalSelected(checked: false)
            }
            //: let currentCell: TalkingPackageGiftCell = self.hotGiftCollectionView.cellForItem(at: indexPath) as! TalkingPackageGiftCell
            let currentCell: ResultWorkThen = self.hotGiftCollectionView.cellForItem(at: indexPath) as! ResultWorkThen
            //: currentCell.setChecked(checked: true)
            currentCell.equalSelected(checked: true)
            //: giftSelectedModel.lastHotIndexPath = indexPath
            giftSelectedModel.lastHotIndexPath = indexPath
            //: giftSelectedModel.lastHotCell = currentCell
            giftSelectedModel.lastHotCell = currentCell
            //: didClickSelectedCellRow(index: 0, title: "")
            turn(index: 0, title: "")
        }
    }

    ///  UIScrollviewDelegate
    //: func scrollViewDidScroll(_ scrollView: UIScrollView) {
    func scrollViewDidScroll(_ scrollView: UIScrollView) {
        //: if scrollView == hotGiftCollectionView {
        if scrollView == hotGiftCollectionView {
            //: updatePageControlAndRefreshUI()
            pieDog()
            //: if isShowRight {
            if isShowRight {
                //: DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 0.3) {
                DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 0.3) {
                    //: self.isShowRight = false
                    self.isShowRight = false
                    //: self.titleScrollView.selectedIndex(0, animated: true)
                    self.titleScrollView.publication(0, animated: true)
                    //: DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 0.5) {
                    DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 0.5) {
                        //: let dataArr = self.getGiftData(dataType: self.currType)
                        let dataArr = self.capability(dataType: self.currType)
                        //: self.hotGiftCollectionView.contentOffset = CGPointZero
                        self.hotGiftCollectionView.contentOffset = CGPointZero
                        //: if self.hotGiftCollectionView.cellForItem(at: IndexPath(item: 0, section: 0)) != nil {
                        if self.hotGiftCollectionView.cellForItem(at: IndexPath(item: 0, section: 0)) != nil {
                            //: if dataArr.count > 0  {
                            if dataArr.count > 0 {
                                //: self.giftSelectedModel.hotGiftNum = 0
                                self.giftSelectedModel.hotGiftNum = 0
                                //: self.collectionView(self.hotGiftCollectionView, didSelectItemAt: IndexPath(item: 0, section: 0))
                                self.collectionView(self.hotGiftCollectionView, didSelectItemAt: IndexPath(item: 0, section: 0))
                            }
                        }
                    }
                }
            }
        }
    }

    /// 刷新UI
    /// - Parameter force: 是否强制刷新
    //: func updatePageControlAndRefreshUI(force: Bool = false) {
    func pieDog(force: Bool = false) {
        // 计算page
        //: var traillingOffsetX = hotGiftCollectionView.contentOffset.x + ScreenWidth
        var traillingOffsetX = hotGiftCollectionView.contentOffset.x + kBlockRateValue
        //: traillingOffsetX = traillingOffsetX < ScreenWidth ? ScreenWidth : traillingOffsetX
        traillingOffsetX = traillingOffsetX < kBlockRateValue ? kBlockRateValue : traillingOffsetX
        //: var page = Int(traillingOffsetX/ScreenWidth-1)
        var page = Int(traillingOffsetX / kBlockRateValue - 1)
        //: page = page < 0 ? 0:page
        page = page < 0 ? 0 : page
        //: let addition = Int(traillingOffsetX)%Int(ScreenWidth) > 0 ? 1:0
        let addition = Int(traillingOffsetX) % Int(kBlockRateValue) > 0 ? 1 : 0
        //: page += addition
        page += addition

        // 判断当前选中分区
        //: var giftType = GiftDataType.Hot
        var giftType = PrixFixeSubscriptType.Hot
        //: if page < hotGiftLayout.hotPage {
        if page < hotGiftLayout.hotPage {
            //: giftType = .Hot
            giftType = .Hot
            //: } else if page < hotGiftLayout.hotPage+hotGiftLayout.vipPage {
        } else if page < hotGiftLayout.hotPage + hotGiftLayout.vipPage {
            //: giftType = .Vip
            giftType = .Vip
            //: page -= hotGiftLayout.hotPage
            page -= hotGiftLayout.hotPage
            //: } else if page < hotGiftLayout.hotPage+hotGiftLayout.vipPage+hotGiftLayout.bagsPage {
        } else if page < hotGiftLayout.hotPage + hotGiftLayout.vipPage + hotGiftLayout.bagsPage {
            //: giftType = .Bags
            giftType = .Bags
            //: page -= (hotGiftLayout.hotPage+hotGiftLayout.vipPage)
            page -= (hotGiftLayout.hotPage + hotGiftLayout.vipPage)
        }

        // 切换分页，刷新UI（添加判断防止频繁调用）
        //: if force == true || currType != giftType {
        if force == true || currType != giftType {
            //: currType = giftType
            currType = giftType
            //: pageControl.numberOfPages = TalkingChatGiftManager.share.getGiftPageCount(perPageCount: 8, dataType: currType)
            pageControl.numberOfPages = TrivialityThen.share.viewTop(perPageCount: 8, dataType: currType)
            // 切换title
            //: titleScrollView.currentIndex = currType.rawValue
            titleScrollView.currentIndex = currType.rawValue
            //: titleScrollView.adjustUIWhenBtnOnClickWithAnimate(true)
            titleScrollView.nameAcrossAnimate(true)
            //: askforBtn.isHidden = !(currType == GiftDataType.Hot && self.style == .normal && ModeStageReactiveCompatible.share.loginUserMode.sex == Gender.female.rawValue)
            askforBtn.isHidden = !(currType == PrixFixeSubscriptType.Hot && self.style == .normal && ModeStageReactiveCompatible.share.loginUserMode.sex == ToClusterLiteral.female.rawValue)
            // 盲盒礼物说明 显示/隐藏
            //: if giftSelectedModel.lastShowType == ChatGiftType.myStery.rawValue && giftSelectedModel.lastHotIndexPath.section == currType.rawValue {
            if giftSelectedModel.lastShowType == LibraryTotalervalLiteral.myStery.rawValue && giftSelectedModel.lastHotIndexPath.section == currType.rawValue {
                //: setsetBlindBoxExplainData(title: giftSelectedModel.lastDescription ?? "")
                finishTable(title: giftSelectedModel.lastDescription ?? "")
                //: } else {
            } else {
                //: blindBoxExplainBtn.isHidden = true
                blindBoxExplainBtn.isHidden = true
            }
            // 空数据缺省图 显示/隐藏
            //: let dataArr = getGiftData(dataType: currType)
            let dataArr = capability(dataType: currType)
            //: giftEmptyView.isHidden = (dataArr.count > 0)
            giftEmptyView.isHidden = (dataArr.count > 0)
            // 手动切换Tab，取消选中状态
            //: if force == false {
            if force == false {
                //: resetGiftSelectedModel()
                barModel()
            }
        }
        //: pageControl.currentPage = page
        pageControl.currentPage = page
    }

    /// 重置选中model
    //: private func resetGiftSelectedModel() {
    private func barModel() {
        //: self.giftSelectedModel = TalkingGiftSelectedModel()
        self.giftSelectedModel = DatabaseTransformable()
        //: self.giftSelectedModel.lastHotIndexPath = IndexPath(item: -1, section: 0)
        self.giftSelectedModel.lastHotIndexPath = IndexPath(item: -1, section: 0)
        /// 导致ihpne11礼物面板消失
        //: hotGiftCollectionView.reloadData()
        hotGiftCollectionView.reloadData()
    }
}

// MARK: - BorderViewDelegate

//: extension TalkingChatGiftView: DropDownMenuViewDelegate {
extension ChatDatabaseThen: BorderViewDelegate {
    //: func didClickSelectedRow(index: Int, title: String) {
    func icon(index: Int, title: String) {
        //: didClickSelectedCellRow(index: index+1, title: title)
        turn(index: index + 1, title: title)
    }

    //: func  didClickSelectedCellRow(index: Int, title: String) {
    func turn(index: Int, title _: String) {
        //: let numberOfGift = numberOfGiftForIndex(index: index)
        let numberOfGift = quantitativeRelationHarvestMoonObservationMe(index: index)
        //: if numberOfGift>0 {
        if numberOfGift > 0 {
            //: giftSelectedModel.hotGiftNum = numberOfGift
            giftSelectedModel.hotGiftNum = numberOfGift
            //: giftNumButton.setTitle(String(numberOfGift), for: .normal)
            giftNumButton.setTitle(String(numberOfGift), for: .normal)
            //: afterChangeNum()
            ice()
            //: } else {
        } else {
            //: popView = TalkingPopView.init(frame: UIScreen.main.bounds)
            popView = SucceedReactiveCompatible(frame: UIScreen.main.bounds)
            //: popView?.initWithView(view: giftInputNumInputView)
            popView?.pastPrice(view: giftInputNumInputView)
            //: popView?.showInView(view: self.window!)
            popView?.product(view: self.window!)
            //: giftInputNameLabel.text = giftSelectedModel.hotGiftName
            giftInputNameLabel.text = giftSelectedModel.hotGiftName
            //: giftInputNumTF.text = String(giftSelectedModel.hotGiftNum)
            giftInputNumTF.text = String(giftSelectedModel.hotGiftNum)
            //: giftInputNumTF.becomeFirstResponder()
            giftInputNumTF.becomeFirstResponder()
        }
    }

    //: func numberOfGiftForIndex(index: Int)->Int {
    func quantitativeRelationHarvestMoonObservationMe(index: Int) -> Int {
        //: let sendingItems = giftSendItems()
        let sendingItems = magnitudeimateLive()
        //: if sendingItems.count>0 &&  index < sendingItems.count {
        if sendingItems.count > 0 && index < sendingItems.count {
            //: let giftNumArrModel: TalkingGiftNumArrModel = sendingItems[index] as! TalkingGiftNumArrModel
            let giftNumArrModel: ValueHandyJSON = sendingItems[index] as! ValueHandyJSON
            //: return giftNumArrModel.num!
            return giftNumArrModel.num!
            //: } else {
        } else {
            //: switch index {
            switch index {
            //: case 0:
            case 0:
                //: return 1
                return 1
            //: case 1:
            case 1:
                //: return 9
                return 9
            //: case 2:
            case 2:
                //: return 99
                return 99
            //: case 3:
            case 3:
                //: return 199
                return 199
            //: case 4:
            case 4:
                //: return 599
                return 599
            //: case 5:
            case 5:
                //: return 999
                return 999
            //: default:
            default:
                //: return 0
                return 0
            }
        }
    }

    //: func indexOfSendItemForNum(num: Int)->Int {
    func isometricWith(num: Int) -> Int {
        //: var index = 0
        var index = 0
        //: for i in 0..<giftSendItems().count {
        for i in 0 ..< magnitudeimateLive().count {
            //: let model: TalkingGiftNumArrModel = giftSendItems()[i] as! TalkingGiftNumArrModel
            let model: ValueHandyJSON = magnitudeimateLive()[i] as! ValueHandyJSON
            //: if model.num == num {
            if model.num == num {
                //: break
                break
            }
            //: index += 1
            index += 1
        }
        //: return index
        return index
    }

    //: func safeObjectAtIndexWithSendItems(addIndex: Int)->Int {
    func via(addIndex: Int) -> Int {
        //: if addIndex > giftSendItems().count-1 {
        if addIndex > magnitudeimateLive().count - 1 {
            //: return 0
            return 0
        }
        //: return addIndex
        return addIndex
    }
}

// MARK: - Layout

//: extension TalkingChatGiftView {
extension ChatDatabaseThen {
    /// 添加视图
    //: private func setupSubviews() {
    private func aggregation() {
        //: self.backgroundColor = UIColor.clear
        self.backgroundColor = UIColor.clear
        //: let tagView = UIView.init(frame: CGRect(x: 0, y: 0, width: ScreenWidth, height: ScreenHeight-contentHeight))
        let tagView = UIView(frame: CGRect(x: 0, y: 0, width: kBlockRateValue, height: kHalfText - contentHeight))
        //: tagView.backgroundColor = .clear
        tagView.backgroundColor = .clear
        //: self.addSubview(tagView)
        self.addSubview(tagView)
        //: tagView.addGestureRecognizer(UITapGestureRecognizer.init(target: self, action: #selector(dismissView)))
        tagView.addGestureRecognizer(UITapGestureRecognizer(target: self, action: #selector(whereabouts)))

        //: if self.style == .party {
        if self.style == .party {
            //: partyIconView.isHidden = false
            partyIconView.isHidden = false
            //: topView.frame.origin.y = partyIconView.frame.height
            topView.frame.origin.y = partyIconView.frame.height

            //: } else {
        } else {
            //: partyIconView.isHidden = true
            partyIconView.isHidden = true
        }

        //: topView.addSubview(titleScrollView)
        topView.addSubview(titleScrollView)

        //: if self.style == .intimatePhoto || self.style == .intimateVideo {
        if self.style == .intimatePhoto || self.style == .intimateVideo {
            //: topView.addSubview(desLab)
            topView.addSubview(desLab)
            //: desLab.snp.makeConstraints { make in
            desLab.snp.makeConstraints { make in
                //: make.trailing.equalToSuperview().offset(-12)
                make.trailing.equalToSuperview().offset(-12)
                //: make.centerY.equalToSuperview()
                make.centerY.equalToSuperview()
            }
            //: } else {
        } else {
            //: topView.addSubview(rechargeBtn)
            topView.addSubview(rechargeBtn)
            //: topView.insertSubview(indicatorImage, belowSubview: rechargeBtn)
            topView.insertSubview(indicatorImage, belowSubview: rechargeBtn)
            //: topView.insertSubview(moneyBtn, belowSubview: rechargeBtn)
            topView.insertSubview(moneyBtn, belowSubview: rechargeBtn)

            //: indicatorImage.snp.makeConstraints { make in
            indicatorImage.snp.makeConstraints { make in
                //: make.centerY.equalTo(topView.snp.centerY)
                make.centerY.equalTo(topView.snp.centerY)
                //: make.trailing.equalTo(topView.snp_trailingMargin).offset(-7)
                make.trailing.equalTo(topView.snp_trailingMargin).offset(-7)
            }
            //: rechargeBtn.snp.makeConstraints { make in
            rechargeBtn.snp.makeConstraints { make in
                //: make.top.trailing.bottom.equalTo(topView)
                make.top.trailing.bottom.equalTo(topView)
                //: make.leading.equalTo(moneyBtn.snp.leading)
                make.leading.equalTo(moneyBtn.snp.leading)
            }
            //: moneyBtn.snp.makeConstraints { make in
            moneyBtn.snp.makeConstraints { make in
                //: make.centerY.equalTo(topView)
                make.centerY.equalTo(topView)
                //: make.trailing.equalTo(indicatorImage.snp.leading).offset(-7)
                make.trailing.equalTo(indicatorImage.snp.leading).offset(-7)
                //: make.width.greaterThanOrEqualTo(90)
                make.width.greaterThanOrEqualTo(90)
            }
        }

        //: contentView.addSubview(scrollContentView)
        contentView.addSubview(scrollContentView)
        //: scrollContentView.snp.makeConstraints { make in
        scrollContentView.snp.makeConstraints { make in
            //: make.top.equalTo(topView.snp.bottom)
            make.top.equalTo(topView.snp.bottom)
            //: make.leading.trailing.equalToSuperview()
            make.leading.trailing.equalToSuperview()
            //: make.height.equalTo(GiftScrollContentView_H)
            make.height.equalTo(k_objectContent)
            //: make.width.equalTo(ScreenWidth)
            make.width.equalTo(kBlockRateValue)
        }

        //: scrollContentView.addSubview(giftEmptyView)
        scrollContentView.addSubview(giftEmptyView)
        //: giftEmptyView.snp.makeConstraints { make in
        giftEmptyView.snp.makeConstraints { make in
            //: make.center.equalToSuperview()
            make.center.equalToSuperview()
        }

        //: scrollContentView.addSubview(hotGiftCollectionView)
        scrollContentView.addSubview(hotGiftCollectionView)
        //: hotGiftCollectionView.snp.makeConstraints { make in
        hotGiftCollectionView.snp.makeConstraints { make in
            //: make.top.equalToSuperview()
            make.top.equalToSuperview()
            //: make.leading.equalTo(5)
            make.leading.equalTo(5)
            //: make.trailing.equalTo(-5)
            make.trailing.equalTo(-5)
            //: make.height.equalTo(GiftScrollContentView_H)
            make.height.equalTo(k_objectContent)
            //: make.width.equalTo(ScreenWidth-10)
            make.width.equalTo(kBlockRateValue - 10)
        }

        //: contentView.addSubview(pageControl)
        contentView.addSubview(pageControl)
        //: pageControl.snp.makeConstraints { make in
        pageControl.snp.makeConstraints { make in
            //: make.centerX.equalTo(contentView)
            make.centerX.equalTo(contentView)
            //: make.height.equalTo(pageControl_H)
            make.height.equalTo(kUserValue)
            //: make.top.equalTo(scrollContentView.snp.bottom)
            make.top.equalTo(scrollContentView.snp.bottom)
        }

        //: contentView.addSubview(bottomView)
        contentView.addSubview(bottomView)
        //: bottomView.snp.makeConstraints { make in
        bottomView.snp.makeConstraints { make in
            //: make.leading.trailing.equalTo(contentView)
            make.leading.trailing.equalTo(contentView)
            //: make.top.equalTo(pageControl.snp.bottom)
            make.top.equalTo(pageControl.snp.bottom)
            //: make.height.equalTo(bottomView_H)
            make.height.equalTo(k_screenTabData)
        }

        //: if self.style == .intimatePhoto || self.style == .intimateVideo {
        if self.style == .intimatePhoto || self.style == .intimateVideo {
            //: bottomView.addSubview(okBtn)
            bottomView.addSubview(okBtn)
            //: okBtn.snp.makeConstraints { make in
            okBtn.snp.makeConstraints { make in
                //: make.trailing.equalToSuperview().offset(-15)
                make.trailing.equalToSuperview().offset(-15)
                //: make.centerY.equalToSuperview()
                make.centerY.equalToSuperview()
                //: make.size.equalTo(CGSize(width: 60, height: 30))
                make.size.equalTo(CGSize(width: 60, height: 30))
            }
            //: } else {
        } else {
            //: bottomView.addSubview(sendAreaView)
            bottomView.addSubview(sendAreaView)
            //: sendAreaView.snp.makeConstraints { make in
            sendAreaView.snp.makeConstraints { make in
                //: make.trailing.equalTo(bottomView).offset(-9)
                make.trailing.equalTo(bottomView).offset(-9)
                //: make.centerY.equalTo(bottomView)
                make.centerY.equalTo(bottomView)
                //: make.height.equalTo(30)
                make.height.equalTo(30)
                //: make.width.equalTo(120)
                make.width.equalTo(120)
            }
            //: sendAreaView.addSubview(giftNumButton)
            sendAreaView.addSubview(giftNumButton)
            //: giftNumButton.snp.makeConstraints { make in
            giftNumButton.snp.makeConstraints { make in
                //: make.top.leading.bottom.equalTo(sendAreaView)
                make.top.leading.bottom.equalTo(sendAreaView)
                //: make.width.equalTo(sendAreaView).multipliedBy(1.0/2)
                make.width.equalTo(sendAreaView).multipliedBy(1.0 / 2)
            }

            //: sendAreaView.addSubview(sendButton)
            sendAreaView.addSubview(sendButton)
            //: sendButton.snp.makeConstraints { make in
            sendButton.snp.makeConstraints { make in
                //: make.top.trailing.bottom.equalTo(sendAreaView)
                make.top.trailing.bottom.equalTo(sendAreaView)
                //: make.width.equalTo(sendAreaView).multipliedBy(1.0/2)
                make.width.equalTo(sendAreaView).multipliedBy(1.0 / 2)
            }

            //: setBlindBoxExplainBtn()
            cancel()

            //: bottomView.addSubview(askforBtn)
            bottomView.addSubview(askforBtn)
            //: askforBtn.snp.makeConstraints { make in
            askforBtn.snp.makeConstraints { make in
                //: make.leading.equalTo(9)
                make.leading.equalTo(9)
                //: make.centerY.equalToSuperview()
                make.centerY.equalToSuperview()
                //: make.size.equalTo(CGSize.init(width: 68, height: 30))
                make.size.equalTo(CGSize(width: 68, height: 30))
            }
        }
    }

    /// 添加事件
    //: private func bindInteraction() {
    private func tabularMatterSumeraction() {
        //: ModeStageReactiveCompatible.share.loginUserMode.rx
        ModeStageReactiveCompatible.share.loginUserMode.rx
            //: .observeWeakly(String.self, "mf_coin")
            .observeWeakly(String.self, (String(user_wrapEnableTitle.suffix(5)) + userManagerMessage.replacingOccurrences(of: "model", with: "in")))
            //: .observe(on: MainScheduler.instance)
            .observe(on: MainScheduler.instance)
            //: .subscribe(onNext: { [weak self] (value) in
            .subscribe(onNext: { [weak self] value in
                //: guard let self = self else { return }
                guard let self = self else { return }
                //: if value != nil {
                if value != nil {
                    //: self.updateGiftInfo(needReload: false, mf_coin: value!)
                    self.doingInfo(needReload: false, mf_coin: value!)
                }
                //: })
            })
            //: .disposed(by: disposeBag)
            .disposed(by: disposeBag)

        // 监听刷新背包
        //: TalkingChatGiftManager.share.rx
        TrivialityThen.share.rx
            //: .observeWeakly(Bool.self, "showBagsRed")
            .observeWeakly(Bool.self, (String(userTopCenterKey.suffix(6)) + String(dreamLoadId)))
            //: .subscribe(onNext: { [weak self] (value) in
            .subscribe(onNext: { [weak self] value in
                //: guard let self = self else { return }
                guard let self = self else { return }
                //: guard value == true else {
                guard value == true else {
                    //: self.titleScrollView.redBagsLab.isHidden = true
                    self.titleScrollView.redBagsLab.isHidden = true
                    //: return
                    return
                }
                // 展示红点
                //: self.titleScrollView.redBagsLab.isHidden = false
                self.titleScrollView.redBagsLab.isHidden = false
                // 刷新礼物接口
                //: TalkingChatGiftManager.share.func__sendGiftEvent(type: self.style, isRefresh: true, completion: {
                TrivialityThen.share.soapResume(type: self.style, isRefresh: true, completion: {
                    //: self.updateGiftInfo(needReload: true, mf_coin: ModeStageReactiveCompatible.share.loginUserMode.mf_coin)
                    self.doingInfo(needReload: true, mf_coin: ModeStageReactiveCompatible.share.loginUserMode.mf_coin)
                    //: })
                })
                //: })
            })
            //: .disposed(by: disposeBag)
            .disposed(by: disposeBag)
    }

    //: func setSeleteMemberList() {
    func aboveCrop() {
        //: bottomView.addSubview(seleteObjectBtn)
        bottomView.addSubview(seleteObjectBtn)
        //: seleteObjectBtn.snp.makeConstraints { make in
        seleteObjectBtn.snp.makeConstraints { make in
            //: make.leading.equalTo(9)
            make.leading.equalTo(9)
            //: make.centerY.equalTo(bottomView)
            make.centerY.equalTo(bottomView)
            //: make.height.equalTo(30)
            make.height.equalTo(30)
            //: make.width.equalTo(113)
            make.width.equalTo(113)
        }
    }

    //: func setBlindBoxExplainBtn() {
    func cancel() {
        //: contentView.addSubview(blindBoxExplainBtn)
        contentView.addSubview(blindBoxExplainBtn)
        //: contentView.insertSubview(blindBoxExplainBtn, at: 99)
        contentView.insertSubview(blindBoxExplainBtn, at: 99)
        //: blindBoxExplainBtn.snp.makeConstraints { make in
        blindBoxExplainBtn.snp.makeConstraints { make in
            //: make.center.equalToSuperview()
            make.center.equalToSuperview()
            //: make.height.equalTo(44)
            make.height.equalTo(44)
            //: make.width.equalTo(340)
            make.width.equalTo(340)
        }
    }
}
